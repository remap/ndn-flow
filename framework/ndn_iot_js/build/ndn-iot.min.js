var Bootstrap=function(a){this.identityManager=new IdentityManager(new IndexedDbIdentityStorage,new IndexedDbPrivateKeyStorage);this.policyManager=new ConfigPolicyManager;this.policyManager.load('validator\n{\n  rule\n  {\n    id "initial rule"\n    for data\n    checker\n    {\n      type hierarchical\n    }\n  }\n}',"default-policy");this.keyChain=new KeyChain(this.identityManager,this.policyManager);this.face=a;this.keyChain.setFace(this.face);this.certificateContentCache=new MemoryContentCache(this.face);
this.trustSchemas={}};
Bootstrap.prototype.setupDefaultIdentityAndRoot=function(a,b,d,c){function f(a){e.identityManager.getDefaultCertificateNameForIdentity(a,function(f){e.defaultIdentity=a;e.defaultCertificateName=f;e.identityManager.getDefaultKeyNameForIdentity(a,function(a){e.defaultKeyName=a;e.face.setCommandSigningInfo(e.keyChain,e.defaultCertificateName);e.certificateContentCache.registerPrefix(new Name(e.defaultCertificateName.getPrefix(-1)),function(a){console.log("Prefix registration failed: "+a.toUri())});e.keyChain.getCertificate(e.defaultCertificateName,
function(a){e.certificateContentCache.add(a);a=a.getSignature().getKeyLocator().getKeyName();void 0!==b&&a.toUri()!==b.toUri()?(a="Configuration signer names mismatch: expected "+b.toUri()+"; got "+a.toUri(),void 0!==c&&c(a)):(e.controllerName=e.getIdentityNameFromCertName(a),console.log("Controller name: "+e.controllerName.toUri()),e.identityManager.getDefaultCertificateNameForIdentity(e.controllerName,function(a){e.keyChain.getCertificate(a,function(a){e.controllerCertificate=a;e.policyManager.certificateCache.insertCertificate(e.controllerCertificate);
void 0!==d&&d(new Name(e.defaultCertificateName),e.keyChain)},function(b){var d="Cannot find controller certificate: "+a.toUri();console.log(b);void 0!==c&&c(d)})},function(a){var b="Cannot find default ceritificate for controller identity: "+e.controllerName.toUri();console.log(a);void 0!==c&&c(b)}))},function(a){a="Certificate does not exist "+e.defaultCertificateName.toUri();void 0!==c&&c(a)})},function(b){console.log(b);b="Identity "+a.toUri()+" in configuration does not have a default key. Please configure the device with this identity first";
void 0!==c&&c(b)})},function(b){console.log(b);b="Identity "+a.toUri()+" in configuration does not have a default certificate. Please configure the device with this identity first";void 0!==c&&c(b)})}var e=this;void 0===a?this.identityManager.getDefaultIdentity(function(a){f(a)},function(a){void 0!==c&&c("Default identity not configured")}):f(a)};
Bootstrap.prototype.startTrustSchemaUpdate=function(a,b,d){a=a.toUri();if(a in this.trustSchemas){if(!0==this.trustSchemas[a].following){console.log("already following trust schema under this namespace: "+a);return}this.trustSchemas[a].following=!0}else this.trustSchemas[a]={following:!0,version:0,"is-initial":!0};a=new Interest((new Name(a)).append("_schema"));a.setChildSelector(1);var c=this;this.face.expressInterest(a,function(a,e){c.onTrustSchemaData(a,e,b,d)},function(a){c.onTrustSchemaTimeout(a,
b,d)})};Bootstrap.prototype.stopTrustSchemaUpdate=function(){console.log("stopTrustSchemaUpdate not implemented")};
Bootstrap.prototype.onSchemaVerified=function(a,b,d){console.log("trust schema verified: "+a.getName().toUri());var c=a.getName().get(-1),f=a.getName().getPrefix(-2).toUri();if(f in this.trustSchemas)if(c.toVersion()<=this.trustSchemas[f].version)console.log("Got out-of-date trust schema"),void 0!==d&&d("Got out-of-date trust schema");else{this.trustSchemas[f].version=c.toVersion();var e=a.getContent().toString("binary");this.trustSchemas[f]["trust-schema"]=e;var g=new Interest((new Name(a.getName())).getPrefix(-1));
g.setChildSelector(1);a.getName().get(-1);a=new Exclude;a.appendAny();a.appendComponent(c);g.setExclude(a);var h=this;this.face.expressInterest(g,function(a,c){h.onTrustSchemaData(a,c,b,d)},function(a){h.onTrustSchemaTimeout(a,b,d)});this.policyManager.load(e,"updated-schema");void 0!==b&&b(e,this.trustSchemas[f]["is-initial"]);this.trustSchemas[f]["is-initial"]=!1}else console.log("unexpected: received trust schema for application namespace that's not being followed; malformed data name?")};
Bootstrap.prototype.onSchemaVerificationFailed=function(a,b,d){console.log("trust schema verification failed");var c=a.getName().getPrefix(-2).toUri();if(c in e._trustSchemas){var f=new Interest((new Name(a.getName())).getPrefix(-1));f.setChildSelector(1);a.getName().get(-1);a=new Exclude;a.appendAny();a.appendComponent(Name.Component.fromVersion(this.trustSchemas[c].version));f.setExclude(a);var e=this;setTimeout(4E3,function(){e.face.expressInterest(f,function(a,c){e.onTrustSchemaData(a,c,b,d)},
function(a){e.onTrustSchemaTimeout(a,b,d)})})}else console.log("unexpected: received trust schema for application namespace that's not being followed; malformed data name?")};
Bootstrap.prototype.onTrustSchemaData=function(a,b,d,c){console.log("Trust schema received: "+b.getName().toUri());b.getName().getPrefix(-2).toUri();if(void 0===this.controllerCertificate)console.log("Controller certificate not yet present, verify once it's in place");else{var f=this;this.keyChain.verifyData(b,function(a){f.onSchemaVerified(a,d,c)},function(a){f.onSchemaVerificationFailed(a,d,c)})}};
Bootstrap.prototype.onTrustSchemaTimeout=function(a,b,d){console.log("Trust schema interest times out: "+a.getName().toUri());a=new Interest(a);a.refreshNonce();var c=this;this.face.expressInterest(a,function(a,e){c.onTrustSchemaData(a,e,b,d)},function(a){c.onTrustSchemaTimeout(a,b,d)})};
Bootstrap.prototype.requestProducerAuthorization=function(a,b,d,c){void 0===this.defaultCertificateName?console.log("Default certificate is missing! Try setupDefaultIdentityAndRoot first?"):this.sendAppRequest(this.defaultCertificateName,a,b,d,c)};
Bootstrap.prototype.sendAppRequest=function(a,b,d,c,f){var e=dcodeIO.ProtoBuf.loadProtoFile("app-request.proto").lookup("AppRequestMessage"),g=e.build(),h=new g;h.command=new g.AppRequest;h.command.idName=new g.Name;h.command.dataPrefix=new g.Name;for(g=0;g<a.size();g++)h.command.idName.add("components",a.get(g).getValue().buf());for(g=0;g<b.size();g++)h.command.dataPrefix.add("components",b.get(g).getValue().buf());h.command.appName=d;a=new Name.Component(ProtobufTlv.encode(h,e));var k=new Interest((new Name(this.controllerName)).append("requests").append(a));
k.setInterestLifetimeMilliseconds(4E3);var l=this;this.face.nodeMakeCommandInterest(k,this.keyChain,this.defaultCertificateName,TlvWireFormat.get(),function(){l.face.expressInterest(k,function(a,b){l.onAppRequestData(a,b,c,f)},function(a){l.onAppRequestTimeout(a,c,f)});console.log("Application publish request sent: "+k.getName().toUri())})};
Bootstrap.prototype.onAppRequestData=function(a,b,d,c){console.log("Got application publishing request data");this.keyChain.verifyData(b,function(a){"200"==JSON.parse(a.getContent().toString("binary")).status?void 0!==d&&d():(console.log("Verified content: "+a.getContent().toString("binary")),void 0!==c&&c(a.getContent().toString("binary")))},function(a){console.log("Application request response verification failed!");void 0!==c&&c("Application request response verification failed!")})};
Bootstrap.prototype.onAppRequestTimeout=function(a,b,d){console.log("Application publishing request times out");a=new Interest(a);a.refreshNonce();var c=this;this.face.expressInterest(a,function(a,e){c.onAppRequestData(a,e,b,d)},function(a){c.onAppRequestTimeout(a,b,d)})};Bootstrap.prototype.onRegisterFailed=function(a){console.log("register failed for prefix "+a.getName().toUri())};
Bootstrap.prototype.getIdentityNameFromCertName=function(a){for(var b=a.size()-1;0<=b&&"KEY"!=a.get(b).toEscapedString();)b-=1;if(0>b)console.log("Error: unexpected certName "+a.toUri());else return new Name(a.getPrefix(b))};Bootstrap.prototype.getKeyChain=function(){return this.keyChain};
var AppConsumer=function(a,b,d,c){this.face=a;this.keyChain=b;this.certificateName=d;this.doVerify=c},AppConsumerTimestamp=function(a,b,d,c,f){AppConsumer.call(this,a,b,d,c);this.currentTimestamp=f;this.defaultInterestLifetime=this.verifyFailedRetransInterval=4E3};
AppConsumerTimestamp.prototype.consume=function(a,b,d,c){var f=this;a=(new Name(a)).append(this.currentSeqNumber.toString());a=new Interest(a);a.setInterestLifetimeMilliseconds(this.defaultInterestLifetime);if(this.currentTimestamp){var e=new Exclude;e.appendAny();e.appendComponent(Name.Component.fromVersion(this.currentTimestamp));a.setExclude()}this.face.expressInterest(a,function(a,e){f.onData(a,e,b,d,c)},function(a){f.beforeReplyTimeout(a,b,d,c)})};
AppConsumerTimestamp.prototype.onData=function(a,b,d,c,f){var e=this;this.doVerify?this.keyChain.verifyData(b,function(a){e.beforeReplyDataVerified(a,d,c,f)},function(b){e.beforeReplyVerificationFailed(b,a,d,c,f)}):this.beforeReplyDataVerified(b,d,c,f)};AppConsumerTimestamp.prototype.beforeReplyDataVerified=function(a,b,d,c){this.currentTimestamp=a.getName().get(-1).toVersion();this.consume(a.getName().getPrefix(-1),b,d,c);this.onVerified(a)};
AppConsumerTimestamp.prototype.beforeReplyVerificationFailed=function(a,b,d,c,f){var e=this,g=new Interest(b);g.refreshNonce();b=new Interest(Name("/local/timeout"));b.setInterestLifetimeMilliseconds(this._verifyFailedRetransInterval);this.face.expressInterest(b,this.onDummyData,function(a){e.retransmitInterest(g,d,c,f)});this.onVerifyFailed(a)};
AppConsumerTimestamp.prototype.beforeReplyTimeout=function(a,b,d,c){var f=this,e=new Interest(a);e.refreshNonce();this.face.expressInterest(e,function(a,e){f.onData(a,e,b,d,c)},function(a){f.beforeReplyTimeout(a,b,d,c)});this.onTimeout(a)};AppConsumerTimestamp.prototype.retransmitInterest=function(a,b,d,c){var f=this;this.face.expressInterest(a,function(a,g){f.onData(a,g,b,d,c)},function(a){f.beforeReplyTimeout(a,b,d,c)})};AppConsumerTimestamp.prototype.onDummyData=function(a,b){console.log("Got unexpected dummy data")};
var AppConsumerSequenceNumber=function(a,b,d,c,f,e){void 0===f&&(f=5);void 0===e&&(e=0);AppConsumer.call(this,a,b,d,c);this.emptySlot=this.pipelineSize=f;this.currentSeqNumber=e;this.defaultInterestLifetime=this.verifyFailedRetransInterval=4E3};
AppConsumerSequenceNumber.prototype.consume=function(a,b,d,c){for(var f=this,e=0;e<emptySlot;e++){var g=(new Name(a)).append(this.currentSeqNumber.toString()),g=new Interest(g);g.setInterestLifetimeMilliseconds(this.defaultInterestLifetime);this.face.expressInterest(g,function(a,e){f.onData(a,e,b,d,c)},function(a){f.beforeReplyTimeout(a,b,d,c)});this.currentSeqNumber-=1;this.emptySlot+=1}};
AppConsumerSequenceNumber.prototype.onData=function(a,b,d,c,f){var e=this;this.doVerify?this.keyChain.verifyData(b,function(a){e.beforeReplyDataVerified(a,d,c,f)},function(b){e.beforeReplyVerificationFailed(b,a,d,c,f)}):this.beforeReplyDataVerified(b,d,c,f)};AppConsumerSequenceNumber.prototype.beforeReplyDataVerified=function(a,b,d,c){this.currentSeqNumber+=1;this.emptySlot+=1;this.consume(a.getName().getPrefix(-1),b,d,c);this.onVerified(a)};
AppConsumerSequenceNumber.prototype.beforeReplyVerificationFailed=function(a,b,d,c,f){var e=this,g=new Interest(b);g.refreshNonce();b=new Interest(Name("/local/timeout"));b.setInterestLifetimeMilliseconds(this._verifyFailedRetransInterval);this.face.expressInterest(b,this.onDummyData,function(a){e.retransmitInterest(g,d,c,f)});this.onVerifyFailed(a)};
AppConsumerSequenceNumber.prototype.beforeReplyTimeout=function(a,b,d,c){var f=this,e=new Interest(a);e.refreshNonce();this.face.expressInterest(e,function(a,e){f.onData(a,e,b,d,c)},function(a){f.beforeReplyTimeout(a,b,d,c)});this.onTimeout(a)};AppConsumerSequenceNumber.prototype.retransmitInterest=function(a,b,d,c){var f=this;this.face.expressInterest(a,function(a,g){f.onData(a,g,b,d,c)},function(a){f.beforeReplyTimeout(a,b,d,c)})};AppConsumerSequenceNumber.prototype.onDummyData=function(a,b){console.log("Got unexpected dummy data")};
var SyncBasedDiscovery=function(a,b,d,c,f,e,g,h,k,l,m,p,q,n){void 0===g&&(g=4E3);void 0===h&&(h="00");void 0===k&&(k=4E3);void 0===l&&(l=500);void 0===m&&(m=3);void 0===n&&(n=1E4);this.face=a;this.keyChain=b;this.syncPrefix=c;this.objects={};this.hostedObjects={};this.memoryContentCache=new MemoryContentCache(this.face);this.certificateName=new Name(d);this.currentDigest=h;this.syncDataFreshnessPeriod=g;this.initialDigest=h;this.syncInterestLifetime=k;this.syncInterestMinInterval=l;this.timeoutCntThreshold=
m;this.entityDataFreshnessPeriod=n;this.observer=f;this.serializer=e};SyncBasedDiscovery.prototype.start=function(){this.updateDigest();var a=new Interest((new Name(this.syncPrefix)).append(this.currentDigest));a.setMustBeFresh(!0);a.setInterestLifetimeMilliseconds(this.syncInterestLifetime);this.face.expressInterest(a,this.onSyncData,this.onSyncTimeout);console.log("Express interest: "+a.getName().toUri())};SyncBasedDiscovery.prototype.stop=function(){this.memoryContentCache.unregisterAll()};
SyncBasedDiscovery.prototype.getHostedObjects=function(){return this.hostedObjects};SyncBasedDiscovery.prototype.getObjects=function(){return this.objects};
SyncBasedDiscovery.prototype.addHostedObject=function(a,b){0==Object.keys(this.hostedObjects).length&&this.memoryContentCache.registerPrefix(this.syncPrefix,this.onRegisterFailed,this.onSyncInterest);this.addObject(a)?(this.hostedObjects[a]=b,this.contentCacheAddEntityData(a,b),this.memoryContentCache.registerPrefix(new Name(a),this.onRegisterFailed,this.onEntityDataNotFound)):console.log("Item with this name already added")};
SyncBasedDiscovery.prototype.removeHostedObject=function(a){if(a in this.hostedObjects){delete this.hostedObjects[a];0==Object.keys(this.hostedObjects).length&&self._memoryContentCache.unregisterAll();if(this.removeObject(a))return!0;console.log("Hosted item not in objects list")}return!1};
SyncBasedDiscovery.prototype.contentCacheAddEntityData=function(a,b){var d=this.serializer.serialize(b),c=new Data(new Name(a));c.setContent(d);c.getMetaInfo().setFreshnessPeriod(self._entityDataFreshnessPeriod);this.keyChain.sign(c,this.certificateName);this.memoryContentCache.add(c);console.log("* added data: "+c.getName().toUri()+"; content: "+d)};
SyncBasedDiscovery.prototype.contentCacheAddSyncData=function(a){var b=Object.keys(this.objects);b.sort();b=JSON.stringify(b);a=new Data(new Name(a));a.setContent(b);a.getMetaInfo().setFreshnessPeriod(this.syncDataFreshnessPeriod);this.keyChain.sign(a,this.certificateName);this.memoryContentCache.add(a);console.log("* added data: "+a.getName().toUri()+"; content: "+b)};
SyncBasedDiscovery.prototype.onSyncInterest=function(a,b,d,c,f){b.getName().size()===this.syncPrefix.size()+1&&(a=b.getName().get(-1).toEscapedString(),this.updateDigest(),a!=this.currentDigest&&this.replySyncInterest(b,a))};SyncBasedDiscovery.prototype.replySyncInterest=function(a,b){this.updateDigest();b!=self._currentDigest&&this.contentCacheAddSyncData((new Name(this.syncPrefix)).append(b))};
SyncBasedDiscovery.prototype.onSyncData=function(a,b){console.log("Got sync data; name: "+b.getName().toUri()+"; content: "+b.getContent().buf());var d=JSON.parse(b.getContent().buf()),c;for(c in d)if(!(c in this.objects))this.onReceivedSyncData(c);d=new Interest(new Name("/local/timeout"));d.setInterestLifetimeMilliseconds(this.syncInterestMinInterval);this.face.expressInterest(d,this.onDummyData,this.expressSyncInterest)};
SyncBasedDiscovery.prototype.onSyncTimeout=function(a){console.log("Sync interest times out: "+a.getName().toUri());a=new Interest((new Name(this.syncPrefix)).append(this.currentDigest));a.setInterestLifetimeMilliseconds(this.syncInterestLifetime);a.setMustBeFresh(!0);this.face.expressInterest(a,this.onSyncData,this.onSyncTimeout);console.log("Express interest: "+a.getName().toUri())};
SyncBasedDiscovery.prototype.onReceivedSyncData=function(a){console.log("Received itemName: "+a);a=new Interest(new Name(a));a.setInterestLifetimeMilliseconds(4E3);a.setMustBeFresh(!1);this.face.expressInterest(a,this.onEntityData,this.onEntityTimeout)};SyncBasedDiscovery.prototype.onEntityTimeout=function(a){console.log("Item interest times out: "+a.getName().toUri())};
SyncBasedDiscovery.prototype.onEntityData=function(a,b){var d=this;console.log("Got data: "+b.getName().toUri());this.addObject(a.getName().toUri());console.log("Added device: "+a.getName().toUri());var c=new Interest(new Name("/local/timeout"));c.setInterestLifetimeMilliseconds(4E3);this.face.expressInterest(c,this.onDummyData,function(b){d.expressHeartbeatInterest(b,a)})};
SyncBasedDiscovery.prototype.expressHeartbeatInterest=function(a,b){(new Interest(b)).refreshNonce();this.face.expressInterest(b,this.onHeartbeatData,this.onHeartbeatTimeout)};SyncBasedDiscovery.prototype.onHeartbeatData=function(a,b){var d=this;this.resetTimeoutCnt(a.getName().toUri());var c=new Interest(new Name("/local/timeout"));c.setInterestLifetimeMilliseconds(4E3);this.face.expressInterest(c,this.onDummyData,function(b){d.expressHeartbeatInterest(b,a)})};
SyncBasedDiscovery.prototype.onHeartbeatTimeout=function(a){this.incrementTimeoutCnt(a.getName().toUri())?console.log("Remove: "+a.getName().toUri()+" because of consecutive timeout cnt exceeded"):(a=new Interest(a.getName()),console.log("Express interest: "+a.getName().toUri()),a.setInterestLifetimeMilliseconds(4E3),this.face.expressInterest(a,this.onHeartbeatData,this.onHeartbeatTimeout))};
SyncBasedDiscovery.prototype.onDummyData=function(a,b){console.log("Unexpected reply to dummy interest: "+b.getContent().buf())};SyncBasedDiscovery.prototype.expressSyncInterest=function(a){a=new Interest((new Name(this.syncPrefix)).append(this.currentDigest));a.setInterestLifetimeMilliseconds(this.syncInterestLifetime);a.setMustBeFresh(!0);this.face.expressInterest(a,this.onSyncData,this.onSyncTimeout);console.log("Dummy timeout; Express interest: "+a.getName().toUri())};
SyncBasedDiscovery.prototype.addObject=function(a){if(a in this.objects)return!1;this.objects[a]={timeout_count:0};this.notifyObserver(a,"ADD","");this.contentCacheAddSyncData((new Name(this.syncPrefix)).append(this.currentDigest));this.updateDigest();return!0};
SyncBasedDiscovery.prototype.removeObject=function(a){return a in this.objects?(delete self._objects[a],this.notifyObserver(a,"REMOVE",""),this.contentCacheAddSyncData((new Name(this.syncPrefix)).append(this.currentDigest)),this.updateDigest(),!0):!1};SyncBasedDiscovery.prototype.updateDigest=function(){var a=Object.keys(this.objects);a.sort();if(0<a.length){for(var b=Crypto.createHash("sha256"),d=0;d<a.length;d++)b.update(a[d]);this.currentDigest=b.digest("hex")}else this.currentDigest=this.initialDigest};
SyncBasedDiscovery.prototype.incrementTimeoutCnt=function(a){return a in this.objects?(this.objects[a].timeout_count+=1,this.objects[a].timeout_count>=this.timeoutCntThreshold?this.removeObject(a):!1):!1};SyncBasedDiscovery.prototype.resetTimeoutCnt=function(a){return a in this.objects?(this.objects[a].timeout_count=0,!0):!1};SyncBasedDiscovery.prototype.notifyObserver=function(a,b,d){this.observer.onStateChanged(a,b,d)};
SyncBasedDiscovery.prototype.onRegisterFailed=function(a){console.log("Prefix registration failed: "+a.toUri())};SyncBasedDiscovery.prototype.onEntityDataNotFound=function(a,b,d,c,f){};
